# 8 多平台账号的ssh key管理
## 8.1 ssh key生成
如果同时使用了多个代码管理平台如github、bitbucket、gitlab等，每个平台均有自己的ssh key或者权限校验方式，此处以ssh key校验为例。
针对不同平台可以在生成ssh key时，指定目录，举例如下：
```shell
# power shell -f之后指定文件路径
# ed25519 为加密方式，现在比rsa更安全、且key更短
ssh-keygen -t ed25519 -C "你的GitHub邮箱" -f /d/mykeys/mygithub
```
若系统不支持ed25519，则使用rsa代替：
```shell
# power shell
ssh-keygen -t rsa -b 4096 -C "你的GitHub邮箱" -f /d/mykeys/mygithub
```
如果直接使用windows cmd, -f之后的路径需要改为如下格式：
```shell
# windows cmd
ssh-keygen -t rsa -b 4096 -C "649333284@qq.com" -f H:\gh\mygithub
```
注意：
1. -f参数必须指定到文件名（不加 .pub，程序会自动生成 .pub 公钥）。
2. 目录必须存在，否则会报 No such file or directory。
3. 在 Git Bash 里目录写法和windows不太一样 H:\ → /h/，D:\ → /d/。
4. 指定文件名，则生成的key文件即指定名称，否则默认为id_rsa（使用rsa的情况下）

## 8.2 多平台ssh key建议管理方式
在同一目录下创建多个子目录来存放不同平台的公私钥，例如：
```
--- C:
------/Users
---------/username
------------/.ssh(假设首次使用的是bitbucket，.ssh目录下存放的是的bitbucket公私钥)
---------------/id_rsa
---------------/id_rsa.pub
------------/github
---------------/id_rsa
---------------/id_rsa.pub
------------/gitlab
---------------/id_rsa
---------------/id_rsa.pub
```
之后，修改默认.ssh目录下的config文件，该文件一般处于系统用户根目录中，如C:\Users\usera\\.ssh ；过配置该文件，对不同平台的私钥进行指向。

注意此处配置的User是git/bitbucket/gitlab服务程序在linux中创建的同一用户，用于进行版本管理工具的相关操作，并非各平台的登录账户。
```
Host git-bb
    HostName bitbucket.org
    User git
    IdentityFile /c/Users/usera/.ssh/id_rsa
    IdentitiesOnly yes


Host git-gh
    HostName github.com
    User git
    IdentityFile /c/Users/usera/github/id_rsa
    IdentitiesOnly yes

Host git-gl
    HostName gitlab.com
    User git
    IdentityFile /c/Users/usera/gitlab/id_rsa
    IdentitiesOnly yes
```

## 8.3 如何使用多ssh key
在完成2中的配置后，使用下方任意的目标地址，即可实现git clone等操作：
```shell
git clone git@git-gh:XXX/xx-xx.git
# 或者（因为 User 已是 git）
git clone git-gh:XXX/xx-xx.git
# 或者显式 ssh URL
git clone ssh://git@git-gh/XXX/xx-xx.git
```
可使用如下命令判断对应配置是否读取了正确的key：
```shell
ssh -G git-gh | findstr -i -E "user|hostname|identityfile|port"
```
预期打印如下信息：
```
user git
hostname github.com
identityfile /c/Users/usera/github/id_rsa
```
测试连通性命令：
```shell
ssh -T git-gh
# 若还不行，开调试看看：
ssh -vvvT git-gh
```
校验公钥是否匹配（指纹校验）：
```shell
ssh-keygen -lf /c/Users/usera/github/id_rsa
```
注意，如果出现如下信息，198.18.0.0/15一般是测试网段，表明网络存在中转，例如处于公司内网或者使用了vpn:
```
Warning: Permanently added the ECDSA host key for IP address '198.18.0.15'...
```
这不一定是问题根源，但如果端口 22 被拦，可能需要改走 443 端口，在 ~/.ssh/config 里给 git-gh 增加
```
Host git-gh
  HostName ssh.github.com
  User git
  Port 443
  IdentityFile /c/Users/usera/github/id_rsa
  IdentitiesOnly yes
```

